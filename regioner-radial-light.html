<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sveriges Regioner ‚Äî Geospatial F√∂rm√•gekarta</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,300&display=swap');
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#f4f5f0;--bg-panel:#ffffff;--border:rgba(0,0,0,0.09);
  --text:#4a5568;--text-dim:#94a3b8;--text-bright:#1a202c;
  --accent:#2563eb;--accent-dim:#eff6ff;
  /* Domain colors */
  --d1:#db2777;--d1f:#fdf2f8;  /* H√§lso- och sjukv√•rd - rose */
  --d2:#0284c7;--d2f:#f0f9ff;  /* Kollektivtrafik - sky */
  --d3:#d97706;--d3f:#fffbeb;  /* Fastighet - amber */
  --d4:#059669;--d4f:#ecfdf5;  /* Regional utveckling - emerald */
  --d5:#7c3aed;--d5f:#f5f3ff;  /* Milj√∂ & klimat - violet */
  --d6:#ea580c;--d6f:#fff7ed;  /* Beredskap - orange */
  /* Capability color */
  --cap:#0891b2;--capf:#ecfeff;
}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;overflow:hidden;height:100vh;display:flex}
#canvas-wrap{flex:1;position:relative;cursor:grab;overflow:hidden}
#canvas-wrap.dragging{cursor:grabbing}
svg#viz{width:100%;height:100%;display:block;background:
  linear-gradient(rgba(0,0,0,0.025) 1px, transparent 1px),
  linear-gradient(90deg, rgba(0,0,0,0.025) 1px, transparent 1px);background-size:50px 50px}

@keyframes pulse-out{0%{r:4;opacity:.7}100%{r:80;opacity:0}}
@keyframes flow{to{stroke-dashoffset:-18}}
.pulse-ring{animation:pulse-out 2.2s ease-out infinite;fill:none;stroke-width:2;pointer-events:none}

#panel{width:310px;min-width:260px;background:var(--bg-panel);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto;position:relative;z-index:10;box-shadow:-2px 0 12px rgba(0,0,0,0.04)}
.ps{padding:13px 16px 11px;border-bottom:1px solid var(--border);flex-shrink:0}
.ps:last-child{border-bottom:none}
#panel h2{font-size:9.5px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--text-dim);margin-bottom:8px}
.sel-name{font-size:15px;font-weight:600;color:var(--text-bright);line-height:1.35;min-height:20px}
.sel-desc{font-size:11px;color:var(--text-dim);line-height:1.5;margin-top:6px;min-height:16px}
.bcrumbs{display:flex;flex-wrap:wrap;gap:3px;align-items:center;margin-top:4px;min-height:14px}
.bcrumbs .crumb{font-size:10.5px;font-weight:500}
.bcrumbs .sep{font-size:10.5px;opacity:.3;margin:0 1px;color:var(--text-dim)}
.btn{background:transparent;border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:11.5px;font-weight:500;padding:8px 11px;border-radius:7px;cursor:pointer;transition:all .15s;text-align:left;width:100%;margin-bottom:5px;display:block}
.btn:last-child{margin-bottom:0}
.btn:hover{background:var(--accent-dim);border-color:var(--accent);color:var(--accent)}

.tr{display:flex;align-items:center;gap:8px;padding:5px 0;cursor:pointer;user-select:none}
.tr:hover .tl{color:var(--text-bright)}
.chk{width:14px;height:14px;border-radius:3px;border:1.5px solid var(--text-dim);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s}
.chk svg{display:none}.tr.active .chk svg{display:block}
.tl{font-size:11.5px;color:var(--text);line-height:1.3}.tr.active .tl{color:var(--text-bright)}

.info-box{background:#f8fafc;border:1px solid rgba(0,0,0,0.08);border-radius:9px;padding:12px 13px;margin-bottom:8px}
.info-hdr{font-size:9.5px;font-weight:700;letter-spacing:1.8px;text-transform:uppercase;display:flex;align-items:center;gap:6px;margin-bottom:8px}
.info-hdr.cap{color:var(--cap)}
.info-hdr.dom{color:var(--accent)}
.info-items{font-size:11px;color:var(--text-dim);line-height:1.6}
.info-items b{color:var(--text-bright);font-weight:500}

.stat-row{display:flex;gap:8px;margin-bottom:4px}
.stat-box{flex:1;background:#f8fafc;border:1px solid rgba(0,0,0,0.08);border-radius:7px;padding:8px 10px;text-align:center}
.stat-val{font-size:18px;font-weight:600;color:var(--accent);line-height:1}
.stat-lbl{font-size:9px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px;margin-top:3px}

.node-group{cursor:pointer}
.node-group:hover .node-ellipse{filter:brightness(1.3)}
.node-ellipse{transition:fill .3s,stroke .3s,opacity .3s}
.node-label{fill:var(--text-bright);font-family:'DM Sans',sans-serif;text-anchor:middle;dominant-baseline:central;pointer-events:none;font-weight:600;transition:opacity .3s}
.edge{stroke-width:1.2;fill:none;opacity:.3}
.node-group.selected .node-ellipse{filter:drop-shadow(0 0 10px rgba(37,99,235,.35))}
.node-group.dimmed .node-ellipse{fill:#f8f9fa!important;stroke:#d1d5db!important;opacity:.35}
.node-group.dimmed .node-label{opacity:.2;fill:#a0aec0}
.edge.dimmed{opacity:.05}

.shared-edge{fill:none;stroke-dasharray:5 4;stroke-width:1.4;opacity:.4;cursor:pointer;transition:opacity .2s,stroke-width .2s}
.shared-edge:hover{opacity:1;stroke-width:2.2}
.shared-label{font-family:'DM Sans',sans-serif;font-size:7.5px;font-weight:500;pointer-events:none;fill:var(--text-dim)}

#tooltip{position:fixed;background:#ffffff;border:1px solid rgba(0,0,0,0.12);color:var(--text-bright);font-family:'DM Sans',sans-serif;font-size:12px;padding:8px 12px;border-radius:8px;pointer-events:none;opacity:0;transition:opacity .15s;z-index:200;max-width:280px;line-height:1.5;box-shadow:0 4px 24px rgba(0,0,0,.12)}
#tooltip.vis{opacity:1}
.ttw{font-size:10.5px;color:var(--text-dim);margin-top:2px}
.panel-hint{font-size:10px;color:var(--text-dim);line-height:1.65;padding:12px 16px}

/* Domain color toggles */
.tr[data-dom="d1"].active .chk{background:var(--d1);border-color:var(--d1)}.tr[data-dom="d1"] .chk{border-color:var(--d1)}
.tr[data-dom="d2"].active .chk{background:var(--d2);border-color:var(--d2)}.tr[data-dom="d2"] .chk{border-color:var(--d2)}
.tr[data-dom="d3"].active .chk{background:var(--d3);border-color:var(--d3)}.tr[data-dom="d3"] .chk{border-color:var(--d3)}
.tr[data-dom="d4"].active .chk{background:var(--d4);border-color:var(--d4)}.tr[data-dom="d4"] .chk{border-color:var(--d4)}
.tr[data-dom="d5"].active .chk{background:var(--d5);border-color:var(--d5)}.tr[data-dom="d5"] .chk{border-color:var(--d5)}
.tr[data-dom="d6"].active .chk{background:var(--d6);border-color:var(--d6)}.tr[data-dom="d6"] .chk{border-color:var(--d6)}
.gen.active .chk{background:var(--cap);border-color:var(--cap)}
</style>
</head>
<body>
<div id="canvas-wrap"><svg id="viz"></svg></div>
<div id="tooltip"><div id="tt-main"></div><div id="tt-w" class="ttw"></div></div>

<div id="panel">
<div class="ps">
  <h2>Vald nod</h2>
  <div class="sel-name" id="sel-name">‚Äî</div>
  <div class="bcrumbs" id="bcrumbs"><span style="color:var(--text-dim);font-size:11px">Klicka p√• en nod</span></div>
  <div class="sel-desc" id="sel-desc"></div>
</div>

<div class="ps" id="info-panel" style="display:none">
  <div class="stat-row" id="stat-row"></div>
  <div class="info-box" id="cap-box" style="display:none">
    <div class="info-hdr cap">üîß Kopplade plattformsf√∂rm√•gor</div>
    <div class="info-items" id="cap-info"></div>
  </div>
  <div class="info-box" id="dom-box" style="display:none">
    <div class="info-hdr dom">üìã Verksamhetskontext</div>
    <div class="info-items" id="dom-info"></div>
  </div>
</div>

<div class="ps">
  <h2>Dom√§nfilter</h2>
  <div class="tr active" data-dom="d1"><span class="chk"><svg width="9" height="7" viewBox="0 0 9 7"><path d="M1 3.5L3 5.5L8 1" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg></span><span class="tl">üè• H√§lso- och sjukv√•rd</span></div>
  <div class="tr active" data-dom="d2"><span class="chk"><svg width="9" height="7" viewBox="0 0 9 7"><path d="M1 3.5L3 5.5L8 1" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg></span><span class="tl">üöå Kollektivtrafik</span></div>
  <div class="tr active" data-dom="d3"><span class="chk"><svg width="9" height="7" viewBox="0 0 9 7"><path d="M1 3.5L3 5.5L8 1" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg></span><span class="tl">üè¢ Fastighets- och lokalstrategi</span></div>
  <div class="tr active" data-dom="d4"><span class="chk"><svg width="9" height="7" viewBox="0 0 9 7"><path d="M1 3.5L3 5.5L8 1" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg></span><span class="tl">üåç Regional utveckling</span></div>
  <div class="tr active" data-dom="d5"><span class="chk"><svg width="9" height="7" viewBox="0 0 9 7"><path d="M1 3.5L3 5.5L8 1" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg></span><span class="tl">üåø Milj√∂, klimat och h√•llbarhet</span></div>
  <div class="tr active" data-dom="d6"><span class="chk"><svg width="9" height="7" viewBox="0 0 9 7"><path d="M1 3.5L3 5.5L8 1" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg></span><span class="tl">üõ°Ô∏è Beredskap och totalf√∂rsvar</span></div>
</div>

<div class="ps">
  <h2>Delade f√∂rm√•gor</h2>
  <div class="tr gen active" id="shared-toggle"><span class="chk"><svg width="9" height="7" viewBox="0 0 9 7"><path d="M1 3.5L3 5.5L8 1" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg></span><span class="tl">Visa tv√§rdom√§nkopplingar</span></div>
  <div class="tr gen active" id="shared-labels-toggle"><span class="chk"><svg width="9" height="7" viewBox="0 0 9 7"><path d="M1 3.5L3 5.5L8 1" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg></span><span class="tl">Visa etiketter</span></div>
</div>

<div class="ps">
  <h2>√Ötg√§rder</h2>
  <button class="btn" id="btn-reset-exp">‚Ü∫ √Öterst√§ll expansion</button>
  <button class="btn" id="btn-reset-view">‚äû √Öterst√§ll vy</button>
  <button class="btn" id="btn-expand-all">‚äï Expandera alla</button>
</div>
<div class="panel-hint">Scroll=zoom ¬∑ Dra=panorera ¬∑ Dubbelklick=passa<br>Klicka nod=expandera/kollapsa<br>Dom√§nfilter highlightar relevanta noder</div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA ‚Äî THREE-LAYER MODEL
// Center: Sveriges Regioner
// Ring 1: Dom√§ner (6)
// Ring 2: Verksamhetsbehov/processer
// Ring 3: Plattformsf√∂rm√•gor (capabilities)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Short capability IDs mapped to full names
const CAP_NAMES = {
  kartor: "Professionella kartor",
  analys: "Geografisk analys & datavetenskap",
  portaler: "Portaler & informationsprodukter",
  dashboards: "Dashboards & nul√§gesbild",
  appar: "Mobila arbetsfl√∂den",
  ruttning: "Ruttning & zonindelning",
  geokod: "Geokodning i X, Y, Z",
  bilder: "Stora m√§ngder bilder",
  treD: "3D-visualisering & analys",
  ai: "AI-bildtolkning & video",
  iot: "IoT & realtidsdata",
  bigdata: "Big Data-analys",
  reality: "Reality capture",
  geodata: "Lagring & underh√•ll geodata",
  cadbim: "CAD/BIM-integration",
  enterprise: "Enterprise-integration"
};

const DATA = {id:"root", label:"Sveriges\nRegioner", meta:{desc:"6 dom√§ner ¬∑ 25 verksamhetsbehov ¬∑ 16 plattformsf√∂rm√•gor"}, children:[

  // ‚ïê‚ïê‚ïê 1. H√ÑLSO- OCH SJUKV√ÖRD ‚ïê‚ïê‚ïê
  {id:"d1", label:"H√§lso- och\nsjukv√•rd", meta:{dom:"d1",icon:"üè•",count:"6 behov",desc:"Kapacitetsplanering, tillg√§nglighet, ambulans, smittspridning, fastighetsbelastning och krisberedskap"}, children:[
    {id:"d1p1", label:"Kapacitets-\nplanering", meta:{dom:"d1",desc:"Bel√§ggningskartor, hotspot-analys, v√•rdtrycksprognos, realtidskapacitet"}, children:[
      {id:"d1p1c1", label:"Dashboards", meta:{type:"cap",cap:"dashboards"}},
      {id:"d1p1c2", label:"Analys", meta:{type:"cap",cap:"analys"}},
      {id:"d1p1c3", label:"Geokodning", meta:{type:"cap",cap:"geokod"}},
      {id:"d1p1c4", label:"Big Data", meta:{type:"cap",cap:"bigdata"}},
      {id:"d1p1c5", label:"Enterprise", meta:{type:"cap",cap:"enterprise"}}
    ]},
    {id:"d1p2", label:"Tillg√§nglighet\n& j√§mlik v√•rd", meta:{dom:"d1",desc:"Restids- och t√§ckningsanalys, v√•rdgap, socioekonomisk koppling"}, children:[
      {id:"d1p2c1", label:"Analys", meta:{type:"cap",cap:"analys"}},
      {id:"d1p2c2", label:"Ruttning", meta:{type:"cap",cap:"ruttning"}},
      {id:"d1p2c3", label:"Portaler", meta:{type:"cap",cap:"portaler"}},
      {id:"d1p2c4", label:"Geokodning", meta:{type:"cap",cap:"geokod"}},
      {id:"d1p2c5", label:"Kartor", meta:{type:"cap",cap:"kartor"}}
    ]},
    {id:"d1p3", label:"Ambulans-\noptimering", meta:{dom:"d1",desc:"Stationeringsoptimering, dynamisk ruttning, realtidssp√•rning, responstidsanalys"}, children:[
      {id:"d1p3c1", label:"Ruttning", meta:{type:"cap",cap:"ruttning"}},
      {id:"d1p3c2", label:"IoT", meta:{type:"cap",cap:"iot"}},
      {id:"d1p3c3", label:"Dashboards", meta:{type:"cap",cap:"dashboards"}},
      {id:"d1p3c4", label:"Analys", meta:{type:"cap",cap:"analys"}},
      {id:"d1p3c5", label:"Appar", meta:{type:"cap",cap:"appar"}}
    ]},
    {id:"d1p4", label:"Smittspridnings-\nanalys", meta:{dom:"d1",desc:"Kluster- och spridningsanalys, folkh√§lsoportal, mobil rapportering"}, children:[
      {id:"d1p4c1", label:"Analys", meta:{type:"cap",cap:"analys"}},
      {id:"d1p4c2", label:"Dashboards", meta:{type:"cap",cap:"dashboards"}},
      {id:"d1p4c3", label:"Geokodning", meta:{type:"cap",cap:"geokod"}},
      {id:"d1p4c4", label:"Portaler", meta:{type:"cap",cap:"portaler"}},
      {id:"d1p4c5", label:"Big Data", meta:{type:"cap",cap:"bigdata"}}
    ]},
    {id:"d1p5", label:"Fastighets-\nbelastning", meta:{dom:"d1",desc:"Digital tvilling v√•rdfastigheter, nyttjandegrad, BIM-koppling, energiuppf√∂ljning"}, children:[
      {id:"d1p5c1", label:"3D", meta:{type:"cap",cap:"treD"}},
      {id:"d1p5c2", label:"CAD/BIM", meta:{type:"cap",cap:"cadbim"}},
      {id:"d1p5c3", label:"IoT", meta:{type:"cap",cap:"iot"}},
      {id:"d1p5c4", label:"Geodata", meta:{type:"cap",cap:"geodata"}},
      {id:"d1p5c5", label:"Dashboards", meta:{type:"cap",cap:"dashboards"}}
    ]},
    {id:"d1p6", label:"Kris-\nberedskap", meta:{dom:"d1",desc:"Samverkansportal, operativ krisdashboard, evakueringsrutter, resurslokalisering"}, children:[
      {id:"d1p6c1", label:"Dashboards", meta:{type:"cap",cap:"dashboards"}},
      {id:"d1p6c2", label:"Portaler", meta:{type:"cap",cap:"portaler"}},
      {id:"d1p6c3", label:"Ruttning", meta:{type:"cap",cap:"ruttning"}},
      {id:"d1p6c4", label:"Appar", meta:{type:"cap",cap:"appar"}},
      {id:"d1p6c5", label:"IoT", meta:{type:"cap",cap:"iot"}}
    ]}
  ]},

  // ‚ïê‚ïê‚ïê 2. KOLLEKTIVTRAFIK ‚ïê‚ïê‚ïê
  {id:"d2", label:"Kollektiv-\ntrafik", meta:{dom:"d2",icon:"üöå",count:"5 behov",desc:"Linjeoptimering, klimatanpassning, resm√∂nster, robusthet vid st√∂rningar och elektrifiering"}, children:[
    {id:"d2p1", label:"Linje-\noptimering", meta:{dom:"d2",desc:"N√§tverksanalys, resm√∂nsteranalys, upptagningsomr√•den, t√§ckning och bel√§ggning"}, children:[
      {id:"d2p1c1", label:"Analys", meta:{type:"cap",cap:"analys"}},
      {id:"d2p1c2", label:"Ruttning", meta:{type:"cap",cap:"ruttning"}},
      {id:"d2p1c3", label:"Big Data", meta:{type:"cap",cap:"bigdata"}},
      {id:"d2p1c4", label:"Dashboards", meta:{type:"cap",cap:"dashboards"}},
      {id:"d2p1c5", label:"Geodata", meta:{type:"cap",cap:"geodata"}}
    ]},
    {id:"d2p2", label:"Klimatanpassning\nav infrastruktur", meta:{dom:"d2",desc:"S√•rbarhetsanalys, alternativa rutter, robusthetsdashboard, klimatriskkartor"}, children:[
      {id:"d2p2c1", label:"Analys", meta:{type:"cap",cap:"analys"}},
      {id:"d2p2c2", label:"Ruttning", meta:{type:"cap",cap:"ruttning"}},
      {id:"d2p2c3", label:"IoT", meta:{type:"cap",cap:"iot"}},
      {id:"d2p2c4", label:"Reality", meta:{type:"cap",cap:"reality"}},
      {id:"d2p2c5", label:"Kartor", meta:{type:"cap",cap:"kartor"}}
    ]},
    {id:"d2p3", label:"Resm√∂nster-\nanalys", meta:{dom:"d2",desc:"Tidsgeografisk analys, prediktiv efterfr√•gemodell, stora resedataset"}, children:[
      {id:"d2p3c1", label:"Big Data", meta:{type:"cap",cap:"bigdata"}},
      {id:"d2p3c2", label:"Analys", meta:{type:"cap",cap:"analys"}},
      {id:"d2p3c3", label:"Dashboards", meta:{type:"cap",cap:"dashboards"}},
      {id:"d2p3c4", label:"AI", meta:{type:"cap",cap:"ai"}},
      {id:"d2p3c5", label:"Geokodning", meta:{type:"cap",cap:"geokod"}}
    ]},
    {id:"d2p4", label:"Robusthet vid\nst√∂rningar", meta:{dom:"d2",desc:"Realtidsstyrning, dynamisk omledning, incidenthantering, fordonssp√•rning"}, children:[
      {id:"d2p4c1", label:"IoT", meta:{type:"cap",cap:"iot"}},
      {id:"d2p4c2", label:"Dashboards", meta:{type:"cap",cap:"dashboards"}},
      {id:"d2p4c3", label:"Ruttning", meta:{type:"cap",cap:"ruttning"}},
      {id:"d2p4c4", label:"Appar", meta:{type:"cap",cap:"appar"}},
      {id:"d2p4c5", label:"Enterprise", meta:{type:"cap",cap:"enterprise"}}
    ]},
    {id:"d2p5", label:"Elektrifiering", meta:{dom:"d2",desc:"Laddinfrastruktur, energibehovsanalys, kapacitetsrisker, dep√•optimering"}, children:[
      {id:"d2p5c1", label:"Analys", meta:{type:"cap",cap:"analys"}},
      {id:"d2p5c2", label:"3D", meta:{type:"cap",cap:"treD"}},
      {id:"d2p5c3", label:"IoT", meta:{type:"cap",cap:"iot"}},
      {id:"d2p5c4", label:"Dashboards", meta:{type:"cap",cap:"dashboards"}},
      {id:"d2p5c5", label:"CAD/BIM", meta:{type:"cap",cap:"cadbim"}}
    ]}
  ]},

  // ‚ïê‚ïê‚ïê 3. FASTIGHETS- OCH LOKALSTRATEGI ‚ïê‚ïê‚ïê
  {id:"d3", label:"Fastighets- och\nlokalstrategi", meta:{dom:"d3",icon:"üè¢",count:"4 behov",desc:"Energioptimering, klimatrisk, lokalf√∂rs√∂rjningsplanering och investeringar"}, children:[
    {id:"d3p1", label:"Energi-\noptimering", meta:{dom:"d3",desc:"Energiprestandaanalys, realtids√∂vervakning, v√§rmel√§ckageidentifiering, energisimulering"}, children:[
      {id:"d3p1c1", label:"IoT", meta:{type:"cap",cap:"iot"}},
      {id:"d3p1c2", label:"3D", meta:{type:"cap",cap:"treD"}},
      {id:"d3p1c3", label:"Dashboards", meta:{type:"cap",cap:"dashboards"}},
      {id:"d3p1c4", label:"AI", meta:{type:"cap",cap:"ai"}},
      {id:"d3p1c5", label:"CAD/BIM", meta:{type:"cap",cap:"cadbim"}}
    ]},
    {id:"d3p2", label:"Klimatrisk", meta:{dom:"d3",desc:"S√•rbarhetsanalys, 3D-riskmodell, realtidsv√§derdata, historisk skadeanalys"}, children:[
      {id:"d3p2c1", label:"Analys", meta:{type:"cap",cap:"analys"}},
      {id:"d3p2c2", label:"3D", meta:{type:"cap",cap:"treD"}},
      {id:"d3p2c3", label:"IoT", meta:{type:"cap",cap:"iot"}},
      {id:"d3p2c4", label:"Reality", meta:{type:"cap",cap:"reality"}},
      {id:"d3p2c5", label:"Bilder", meta:{type:"cap",cap:"bilder"}}
    ]},
    {id:"d3p3", label:"Lokalf√∂rs√∂rjnings-\nplanering", meta:{dom:"d3",desc:"Demografisk behovsanalys, 3D-scenariomodellering, kapacitetsdashboard"}, children:[
      {id:"d3p3c1", label:"Analys", meta:{type:"cap",cap:"analys"}},
      {id:"d3p3c2", label:"3D", meta:{type:"cap",cap:"treD"}},
      {id:"d3p3c3", label:"Dashboards", meta:{type:"cap",cap:"dashboards"}},
      {id:"d3p3c4", label:"CAD/BIM", meta:{type:"cap",cap:"cadbim"}},
      {id:"d3p3c5", label:"Geodata", meta:{type:"cap",cap:"geodata"}}
    ]},
    {id:"d3p4", label:"Investeringar", meta:{dom:"d3",desc:"Scenario- och prognosanalys, CAPEX-dashboard, 3D-investeringsscenarier"}, children:[
      {id:"d3p4c1", label:"Analys", meta:{type:"cap",cap:"analys"}},
      {id:"d3p4c2", label:"Dashboards", meta:{type:"cap",cap:"dashboards"}},
      {id:"d3p4c3", label:"3D", meta:{type:"cap",cap:"treD"}},
      {id:"d3p4c4", label:"Enterprise", meta:{type:"cap",cap:"enterprise"}},
      {id:"d3p4c5", label:"Kartor", meta:{type:"cap",cap:"kartor"}}
    ]}
  ]},

  // ‚ïê‚ïê‚ïê 4. REGIONAL UTVECKLING OCH SAMH√ÑLLSPLANERING ‚ïê‚ïê‚ïê
  {id:"d4", label:"Regional utveckling\n& samh√§llsplanering", meta:{dom:"d4",icon:"üåç",count:"4 behov",desc:"N√§ringslivsetableringar, infrastrukturprioritering, demografiska f√∂r√§ndringar och landsbygdsutveckling"}, children:[
    {id:"d4p1", label:"N√§ringslivs-\netableringar", meta:{dom:"d4",desc:"Plats- och konkurrensanalys, klusterdashboard, f√∂retags- och syssels√§ttningsdata"}, children:[
      {id:"d4p1c1", label:"Analys", meta:{type:"cap",cap:"analys"}},
      {id:"d4p1c2", label:"Portaler", meta:{type:"cap",cap:"portaler"}},
      {id:"d4p1c3", label:"Dashboards", meta:{type:"cap",cap:"dashboards"}},
      {id:"d4p1c4", label:"Big Data", meta:{type:"cap",cap:"bigdata"}},
      {id:"d4p1c5", label:"Geokodning", meta:{type:"cap",cap:"geokod"}}
    ]},
    {id:"d4p2", label:"Infrastruktur-\nprioritering", meta:{dom:"d4",desc:"Trafik- och kapacitetsanalys, investeringsdashboard, 3D-korridormodellering"}, children:[
      {id:"d4p2c1", label:"Analys", meta:{type:"cap",cap:"analys"}},
      {id:"d4p2c2", label:"3D", meta:{type:"cap",cap:"treD"}},
      {id:"d4p2c3", label:"Dashboards", meta:{type:"cap",cap:"dashboards"}},
      {id:"d4p2c4", label:"Big Data", meta:{type:"cap",cap:"bigdata"}},
      {id:"d4p2c5", label:"CAD/BIM", meta:{type:"cap",cap:"cadbim"}}
    ]},
    {id:"d4p3", label:"Demografiska\nf√∂r√§ndringar", meta:{dom:"d4",desc:"Prognos- och segregationsanalys, socioekonomiska dataset, befolkningsvisualisering"}, children:[
      {id:"d4p3c1", label:"Analys", meta:{type:"cap",cap:"analys"}},
      {id:"d4p3c2", label:"Dashboards", meta:{type:"cap",cap:"dashboards"}},
      {id:"d4p3c3", label:"Big Data", meta:{type:"cap",cap:"bigdata"}},
      {id:"d4p3c4", label:"Geokodning", meta:{type:"cap",cap:"geokod"}},
      {id:"d4p3c5", label:"Portaler", meta:{type:"cap",cap:"portaler"}}
    ]},
    {id:"d4p4", label:"Landsbygds-\nutveckling", meta:{dom:"d4",desc:"Tillg√§nglighetsanalys, funktionella arbetsmarknadsregioner, restidszoner, gr√∂n infrastruktur"}, children:[
      {id:"d4p4c1", label:"Analys", meta:{type:"cap",cap:"analys"}},
      {id:"d4p4c2", label:"Ruttning", meta:{type:"cap",cap:"ruttning"}},
      {id:"d4p4c3", label:"Kartor", meta:{type:"cap",cap:"kartor"}},
      {id:"d4p4c4", label:"Portaler", meta:{type:"cap",cap:"portaler"}},
      {id:"d4p4c5", label:"Geodata", meta:{type:"cap",cap:"geodata"}}
    ]}
  ]},

  // ‚ïê‚ïê‚ïê 5. MILJ√ñ, KLIMAT OCH H√ÖLLBARHET ‚ïê‚ïê‚ïê
  {id:"d5", label:"Milj√∂, klimat\n& h√•llbarhet", meta:{dom:"d5",icon:"üåø",count:"4 behov",desc:"Utsl√§ppsanalys, naturv√§rden, klimatanpassning och uppf√∂ljning mot m√•l"}, children:[
    {id:"d5p1", label:"Utsl√§pps-\nanalys", meta:{dom:"d5",desc:"Utsl√§ppskartl√§ggning, sektorsanalys, klimatbudgetportal, AI-markklassning"}, children:[
      {id:"d5p1c1", label:"Analys", meta:{type:"cap",cap:"analys"}},
      {id:"d5p1c2", label:"Dashboards", meta:{type:"cap",cap:"dashboards"}},
      {id:"d5p1c3", label:"Big Data", meta:{type:"cap",cap:"bigdata"}},
      {id:"d5p1c4", label:"AI", meta:{type:"cap",cap:"ai"}},
      {id:"d5p1c5", label:"Kartor", meta:{type:"cap",cap:"kartor"}}
    ]},
    {id:"d5p2", label:"Naturv√§rden", meta:{dom:"d5",desc:"Ekologisk konnektivitetsanalys, gr√∂nstruktur, 3D-landskapsmodell, satellitarkiv"}, children:[
      {id:"d5p2c1", label:"Analys", meta:{type:"cap",cap:"analys"}},
      {id:"d5p2c2", label:"Bilder", meta:{type:"cap",cap:"bilder"}},
      {id:"d5p2c3", label:"AI", meta:{type:"cap",cap:"ai"}},
      {id:"d5p2c4", label:"Reality", meta:{type:"cap",cap:"reality"}},
      {id:"d5p2c5", label:"Geodata", meta:{type:"cap",cap:"geodata"}}
    ]},
    {id:"d5p3", label:"Klimat-\nanpassning", meta:{dom:"d5",desc:"S√•rbarhets- och konsekvensanalys, 3D-riskmodell, realtidsv√§der, historiska klimath√§ndelser"}, children:[
      {id:"d5p3c1", label:"Analys", meta:{type:"cap",cap:"analys"}},
      {id:"d5p3c2", label:"3D", meta:{type:"cap",cap:"treD"}},
      {id:"d5p3c3", label:"IoT", meta:{type:"cap",cap:"iot"}},
      {id:"d5p3c4", label:"Reality", meta:{type:"cap",cap:"reality"}},
      {id:"d5p3c5", label:"Bilder", meta:{type:"cap",cap:"bilder"}}
    ]},
    {id:"d5p4", label:"Uppf√∂ljning\nmot m√•l", meta:{dom:"d5",desc:"Trend- och effektanalys, KPI-dashboard, l√•ngtidsdata, indikatorkartor"}, children:[
      {id:"d5p4c1", label:"Dashboards", meta:{type:"cap",cap:"dashboards"}},
      {id:"d5p4c2", label:"Portaler", meta:{type:"cap",cap:"portaler"}},
      {id:"d5p4c3", label:"Big Data", meta:{type:"cap",cap:"bigdata"}},
      {id:"d5p4c4", label:"Enterprise", meta:{type:"cap",cap:"enterprise"}},
      {id:"d5p4c5", label:"Kartor", meta:{type:"cap",cap:"kartor"}}
    ]}
  ]},

  // ‚ïê‚ïê‚ïê 6. BEREDSKAP OCH TOTALF√ñRSVAR ‚ïê‚ïê‚ïê
  {id:"d6", label:"Beredskap &\ntotalf√∂rsvar", meta:{dom:"d6",icon:"üõ°Ô∏è",count:"4 behov",desc:"Kritisk infrastruktur, resiliens, samordning och situationsbild"}, children:[
    {id:"d6p1", label:"Kritisk\ninfrastruktur", meta:{dom:"d6",desc:"N√§tverks- och kaskadanalys, beroendedashboard, AI-s√•rbarhetsanalys, infrastrukturdatabas"}, children:[
      {id:"d6p1c1", label:"Analys", meta:{type:"cap",cap:"analys"}},
      {id:"d6p1c2", label:"3D", meta:{type:"cap",cap:"treD"}},
      {id:"d6p1c3", label:"IoT", meta:{type:"cap",cap:"iot"}},
      {id:"d6p1c4", label:"AI", meta:{type:"cap",cap:"ai"}},
      {id:"d6p1c5", label:"Geodata", meta:{type:"cap",cap:"geodata"}}
    ]},
    {id:"d6p2", label:"Resiliens", meta:{dom:"d6",desc:"Kontinuitetsplanering, kritikalitetsanalys, alternativa lokaler, beroendemodell"}, children:[
      {id:"d6p2c1", label:"Analys", meta:{type:"cap",cap:"analys"}},
      {id:"d6p2c2", label:"Dashboards", meta:{type:"cap",cap:"dashboards"}},
      {id:"d6p2c3", label:"Portaler", meta:{type:"cap",cap:"portaler"}},
      {id:"d6p2c4", label:"3D", meta:{type:"cap",cap:"treD"}},
      {id:"d6p2c5", label:"Enterprise", meta:{type:"cap",cap:"enterprise"}}
    ]},
    {id:"d6p3", label:"Samordning", meta:{dom:"d6",desc:"Samverkan region-kommun-stat, gemensam l√§gesdashboard, evakueringsplanering"}, children:[
      {id:"d6p3c1", label:"Portaler", meta:{type:"cap",cap:"portaler"}},
      {id:"d6p3c2", label:"Dashboards", meta:{type:"cap",cap:"dashboards"}},
      {id:"d6p3c3", label:"Ruttning", meta:{type:"cap",cap:"ruttning"}},
      {id:"d6p3c4", label:"Appar", meta:{type:"cap",cap:"appar"}},
      {id:"d6p3c5", label:"Enterprise", meta:{type:"cap",cap:"enterprise"}}
    ]},
    {id:"d6p4", label:"Situations-\nbild", meta:{dom:"d6",desc:"Operativ realtidsdashboard, f√§ltapp, dr√∂narst√∂d, AI-incidentdetektion, sensorintegration"}, children:[
      {id:"d6p4c1", label:"Dashboards", meta:{type:"cap",cap:"dashboards"}},
      {id:"d6p4c2", label:"IoT", meta:{type:"cap",cap:"iot"}},
      {id:"d6p4c3", label:"AI", meta:{type:"cap",cap:"ai"}},
      {id:"d6p4c4", label:"Reality", meta:{type:"cap",cap:"reality"}},
      {id:"d6p4c5", label:"Appar", meta:{type:"cap",cap:"appar"}}
    ]}
  ]}
]};

// CROSS-DOMAIN SHARED CAPABILITIES ‚Äî same capability needed across domains
const SHARED = [
  // Dashboards used across crisis domains
  {from:"d1p6c1", to:"d6p4c1", label:"Krisdashboard"},
  // Ruttning shared: ambulans ‚Üî kollektivtrafik ‚Üî beredskap
  {from:"d1p3c1", to:"d2p4c3", label:"Ruttoptimering"},
  {from:"d1p6c3", to:"d6p3c3", label:"Evakueringsrutter"},
  // IoT shared: fastighet ‚Üî kollektivtrafik
  {from:"d3p1c1", to:"d2p5c3", label:"Energi-IoT"},
  // 3D shared: fastighet ‚Üî beredskap
  {from:"d3p3c2", to:"d6p1c2", label:"3D-infrastruktur"},
  {from:"d1p5c1", to:"d3p3c2", label:"Digital tvilling"},
  // Analys tv√§rdom√§n
  {from:"d5p3c1", to:"d3p2c1", label:"Klimatriskanalys"},
  {from:"d4p3c1", to:"d1p1c2", label:"Demografisk analys"},
  // AI cross-domain
  {from:"d5p2c3", to:"d6p1c4", label:"AI-bildtolkning"},
  // Big Data cross
  {from:"d2p3c1", to:"d4p1c4", label:"Mobilitetsm√∂nster"},
  // Portal/samverkan
  {from:"d6p2c3", to:"d1p6c2", label:"Samverkansportal"},
  // Reality capture cross
  {from:"d5p3c4", to:"d2p2c4", label:"Reality capture"},
];

// DOMAIN SETS
const DOM_SETS = {
  d1: new Set(["d1"]),
  d2: new Set(["d2"]),
  d3: new Set(["d3"]),
  d4: new Set(["d4"]),
  d5: new Set(["d5"]),
  d6: new Set(["d6"])
};

// DOMAIN COLORS
const DOM_COLORS = {
  d1: {stroke:'var(--d1)',fill:'var(--d1f)'},
  d2: {stroke:'var(--d2)',fill:'var(--d2f)'},
  d3: {stroke:'var(--d3)',fill:'var(--d3f)'},
  d4: {stroke:'var(--d4)',fill:'var(--d4f)'},
  d5: {stroke:'var(--d5)',fill:'var(--d5f)'},
  d6: {stroke:'var(--d6)',fill:'var(--d6f)'}
};

// VISUAL CONFIG per depth
const DCFG = [
  {rx:82,ry:34,fs:12.5,arm:0,stroke:'var(--accent)',fill:'var(--accent-dim)'},
  {rx:66,ry:26,fs:10.5,arm:220,stroke:'var(--accent)',fill:'var(--accent-dim)'},
  {rx:52,ry:20,fs:9.5,arm:170,stroke:'var(--accent)',fill:'var(--accent-dim)'},
  {rx:38,ry:15,fs:8,arm:130,stroke:'var(--cap)',fill:'var(--capf)'},
];
function dcfg(d){return DCFG[Math.min(d,DCFG.length-1)]}

// STATE
let expandedIds = new Set();
let selectedId = null;
const domVis = {d1:true,d2:true,d3:true,d4:true,d5:true,d6:true};
let showShared = true, showSharedLabels = true;
let nodeMap = {};
let vb = {x:-600,y:-500,w:1200,h:1000};

function enrich(n,p,d){
  n.depth=d; n.parent=p; n.x=0; n.y=0;
  nodeMap[n.id]=n;
  if(n.children) n.children.forEach(c=>enrich(c,n,d+1));
}
enrich(DATA,null,0);

function getDom(id){
  const n=nodeMap[id];
  if(!n) return null;
  if(n.meta && n.meta.dom) return n.meta.dom;
  if(n.parent) return getDom(n.parent.id);
  return null;
}
function domColor(dom){return DOM_COLORS[dom]||{stroke:'var(--accent)',fill:'var(--accent-dim)'}}

// LAYOUT
function countV(n){if(!n.children||!expandedIds.has(n.id))return 1;return 1+n.children.reduce((s,c)=>s+countV(c),0)}
function layout(){DATA.x=0;DATA.y=0;if(expandedIds.has(DATA.id))ring(DATA,-Math.PI,Math.PI)}
function ring(parent,ss,se){
  if(!parent.children||!expandedIds.has(parent.id)) return;
  const kids=parent.children, cd=parent.depth+1, dcc=dcfg(cd), dcp=dcfg(parent.depth);
  const ts=se-ss;
  let arm=Math.max(dcc.arm, dcp.rx+dcc.rx+35);
  const ns=2*dcc.rx+16, ma=ns/arm;
  if(ma*kids.length>ts) arm=(ma*kids.length*arm)/ts;
  const wts=kids.map(c=>countV(c)), tw=wts.reduce((a,b)=>a+b,0);
  let arcs=wts.map(w=>Math.max((w/tw)*ts,ma));
  const as2=arcs.reduce((a,b)=>a+b,0); arcs=arcs.map(a=>a*(ts/as2));
  let ang=ss;
  kids.forEach((child,i)=>{
    const arc=arcs[i], mid=ang+arc/2;
    child.x=parent.x+arm*Math.cos(mid);
    child.y=parent.y+arm*Math.sin(mid);
    if(expandedIds.has(child.id)&&child.children) ring(child,ang,ang+arc);
    ang+=arc;
  });
}
function collectV(n,out){out.push(n);if(n.children&&expandedIds.has(n.id))n.children.forEach(c=>collectV(c,out))}
function fitVB(){
  const vis=[];collectV(DATA,vis);
  if(vis.length<=1){vb={x:-600,y:-500,w:1200,h:1000};return}
  let x0=1e9,x1=-1e9,y0=1e9,y1=-1e9;
  vis.forEach(n=>{const c=dcfg(n.depth);x0=Math.min(x0,n.x-c.rx-25);x1=Math.max(x1,n.x+c.rx+25);y0=Math.min(y0,n.y-c.ry-25);y1=Math.max(y1,n.y+c.ry+25)});
  vb={x:x0-70,y:y0-70,w:x1-x0+140,h:y1-y0+140};
}

function getPath(id){const ids=[];let n=nodeMap[id];while(n){ids.unshift(n.id);n=n.parent}return ids}
function toggleExp(id){const n=nodeMap[id];if(!n.children||!n.children.length)return;if(expandedIds.has(id))collSub(id);else expandedIds.add(id)}
function collSub(id){expandedIds.delete(id);const n=nodeMap[id];if(n.children)n.children.forEach(c=>collSub(c.id))}
function resetExp(){expandedIds.clear();selectedId=null;renderFit();updatePanel()}
function expandAll(){
  function expR(n){expandedIds.add(n.id);if(n.children)n.children.forEach(c=>expR(c))}
  expR(DATA);renderFit();
}

// RENDER
const svg=document.getElementById('viz'), NS='http://www.w3.org/2000/svg';
function applyVB(){svg.setAttribute('viewBox',`${vb.x} ${vb.y} ${vb.w} ${vb.h}`)}
function render(){layout();draw()}
function renderFit(){layout();fitVB();draw()}

function draw(){
  svg.innerHTML='';
  // Background click handler
  const bg=document.createElementNS(NS,'rect');
  bg.setAttribute('x',-1e5);bg.setAttribute('y',-1e5);bg.setAttribute('width',2e5);bg.setAttribute('height',2e5);bg.setAttribute('fill','transparent');
  bg.addEventListener('click',()=>{selectedId=null;render();updatePanel()});
  svg.appendChild(bg);

  const vis=[];collectV(DATA,vis);
  const visSet=new Set(vis.map(n=>n.id));

  // Check domain dimming
  const anyFilter=Object.values(domVis).some(v=>!v);
  function isDimmed(node){
    if(!anyFilter) return false;
    const d=getDom(node.id);
    if(!d) return false;
    return !domVis[d];
  }

  // Parent-child edges
  vis.forEach(node=>{
    if(!node.parent||!visSet.has(node.parent.id)) return;
    const ln=document.createElementNS(NS,'line');
    ln.setAttribute('x1',node.parent.x);ln.setAttribute('y1',node.parent.y);
    ln.setAttribute('x2',node.x);ln.setAttribute('y2',node.y);
    const dim=isDimmed(node);
    const dom=getDom(node.id);
    const dc=domColor(dom);
    ln.setAttribute('stroke',dc.stroke);
    ln.setAttribute('class','edge'+(dim?' dimmed':''));
    svg.appendChild(ln);
  });

  // Shared capability edges
  if(showShared){
    SHARED.forEach(dep=>{
      if(!visSet.has(dep.from)||!visSet.has(dep.to)) return;
      const A=nodeMap[dep.from], B=nodeMap[dep.to];
      const mx=(A.x+B.x)/2, my=(A.y+B.y)/2;
      const dx=B.x-A.x, dy=B.y-A.y, len=Math.sqrt(dx*dx+dy*dy)||1;
      const cv=Math.min(len*0.3,90);
      const cpx=mx-dy/len*cv, cpy=my+dx/len*cv;
      const path=document.createElementNS(NS,'path');
      path.setAttribute('d',`M${A.x},${A.y} Q${cpx},${cpy} ${B.x},${B.y}`);
      path.setAttribute('class','shared-edge');
      path.setAttribute('stroke','var(--cap)');
      path.addEventListener('mouseenter',e=>{
        document.getElementById('tt-main').textContent=dep.label;
        document.getElementById('tt-w').textContent=`${nodeMap[dep.from]?.label.replace(/\n/g,' ')} ‚Üî ${nodeMap[dep.to]?.label.replace(/\n/g,' ')}`;
        tt.classList.add('vis');moveTT(e);
      });
      path.addEventListener('mousemove',e=>moveTT(e));
      path.addEventListener('mouseleave',()=>tt.classList.remove('vis'));
      svg.appendChild(path);

      if(showSharedLabels){
        const t=0.5;
        const lx=(1-t)*(1-t)*A.x+2*(1-t)*t*cpx+t*t*B.x;
        const ly=(1-t)*(1-t)*A.y+2*(1-t)*t*cpy+t*t*B.y;
        const lbl=document.createElementNS(NS,'text');
        lbl.setAttribute('x',lx);lbl.setAttribute('y',ly);
        lbl.setAttribute('class','shared-label');lbl.setAttribute('text-anchor','middle');
        lbl.textContent=dep.label;svg.appendChild(lbl);
      }
    });
  }

  // Nodes
  vis.forEach(node=>{
    const cfg=dcfg(node.depth);
    const dim=isDimmed(node);
    const sel=node.id===selectedId;
    const dom=getDom(node.id);
    const dc=domColor(dom);
    const isCap=node.meta?.type==='cap';

    const g=document.createElementNS(NS,'g');
    g.setAttribute('class','node-group'+(sel?' selected':'')+(dim?' dimmed':''));
    g.dataset.id=node.id;

    const el=document.createElementNS(NS,'ellipse');
    el.setAttribute('cx',node.x);el.setAttribute('cy',node.y);
    el.setAttribute('rx',cfg.rx);el.setAttribute('ry',cfg.ry);

    let stroke=cfg.stroke, fill=cfg.fill;
    // Domain-level coloring (depth 1 = domain)
    if(node.depth===1 && dom){stroke=dc.stroke;fill=dc.fill}
    // Process-level (depth 2)  ‚Äî use domain color but slightly different
    if(node.depth===2 && dom){stroke=dc.stroke;fill=dc.fill}
    // Capability-level (depth 3) ‚Äî use capability color
    if(isCap){stroke='var(--cap)';fill='var(--capf)'}

    el.setAttribute('fill',fill);el.setAttribute('stroke',stroke);
    el.setAttribute('stroke-width',sel?2.8:1.5);
    el.setAttribute('class','node-ellipse');
    g.appendChild(el);

    // Expand dot
    if(node.children&&node.children.length){
      const dot=document.createElementNS(NS,'circle');
      dot.setAttribute('cx',node.x+cfg.rx-6);dot.setAttribute('cy',node.y-cfg.ry+6);dot.setAttribute('r',3);
      dot.setAttribute('fill',expandedIds.has(node.id)?stroke:'transparent');
      dot.setAttribute('stroke',stroke);dot.setAttribute('stroke-width','1');dot.setAttribute('opacity','0.8');
      g.appendChild(dot);
    }

    // Label
    const fs=cfg.fs, lines=node.label.split('\n');
    const txt=document.createElementNS(NS,'text');
    txt.setAttribute('class','node-label');txt.setAttribute('font-size',fs);
    if(isCap) txt.setAttribute('fill','var(--cap)');
    const lh=fs*1.25, th=lines.length*lh, sy=node.y-th/2+lh/2;
    lines.forEach((l,li)=>{
      const ts=document.createElementNS(NS,'tspan');
      ts.setAttribute('x',node.x);ts.setAttribute('y',sy+li*lh);ts.textContent=l;txt.appendChild(ts);
    });
    g.appendChild(txt);

    // Tooltip on hover
    g.addEventListener('mouseenter',e=>{
      const m=node.meta||{};
      let main=node.label.replace(/\n/g,' ');
      let sub='';
      if(isCap && m.cap){main=CAP_NAMES[m.cap]||main;sub='Plattformsf√∂rm√•ga'}
      else if(m.desc){sub=m.desc}
      else if(m.count){sub=m.count}
      document.getElementById('tt-main').textContent=main;
      document.getElementById('tt-w').textContent=sub;
      tt.classList.add('vis');moveTT(e);
    });
    g.addEventListener('mousemove',e=>moveTT(e));
    g.addEventListener('mouseleave',()=>tt.classList.remove('vis'));

    g.addEventListener('click',onNode);
    svg.appendChild(g);
  });

  // Pulse ring on selected
  if(selectedId&&visSet.has(selectedId)){
    const sn=nodeMap[selectedId];
    const ring=document.createElementNS(NS,'circle');
    ring.setAttribute('cx',sn.x);ring.setAttribute('cy',sn.y);ring.setAttribute('r','4');
    const dom=getDom(selectedId);
    const dc=domColor(dom);
    ring.setAttribute('stroke',nodeMap[selectedId].meta?.type==='cap'?'var(--cap)':dc.stroke);
    ring.setAttribute('class','pulse-ring');
    svg.appendChild(ring);
  }

  applyVB();
}

// TOOLTIP
const tt=document.getElementById('tooltip');
function moveTT(e){tt.style.left=(e.clientX+14)+'px';tt.style.top=(e.clientY-10)+'px'}

// INTERACTIONS
function onNode(e){
  e.stopPropagation();
  const id=e.currentTarget.dataset.id;
  selectedId=id;toggleExp(id);
  if(expandedIds.has(id))renderFit();else render();
  updatePanel();
}

function updatePanel(){
  const nm=document.getElementById('sel-name'), bc=document.getElementById('bcrumbs');
  const desc=document.getElementById('sel-desc');
  const infoPanel=document.getElementById('info-panel');
  const capBox=document.getElementById('cap-box'), domBox=document.getElementById('dom-box');
  const statRow=document.getElementById('stat-row');

  if(!selectedId){
    nm.textContent='‚Äî';
    bc.innerHTML='<span style="color:var(--text-dim);font-size:11px">Klicka p√• en nod</span>';
    desc.textContent='';infoPanel.style.display='none';return;
  }

  const node=nodeMap[selectedId];
  nm.textContent=node.label.replace(/\n/g,' ');
  const path=getPath(selectedId);
  bc.innerHTML=path.map((pid,i)=>{
    const n=nodeMap[pid], dom=getDom(pid);
    const dc=domColor(dom);
    const col=n.meta?.type==='cap'?'var(--cap)':dc.stroke;
    return`<span class="crumb" style="color:${col}">${n.label.replace(/\n/g,' ')}</span>`+(i<path.length-1?'<span class="sep">‚Ä∫</span>':'');
  }).join('');

  const m=node.meta||{};

  // For capability nodes
  if(m.type==='cap' && m.cap){
    desc.textContent='Plattformsf√∂rm√•ga';
    infoPanel.style.display='block';
    statRow.innerHTML='';

    // Count how many processes use this capability
    const capId=m.cap;
    let usageCount=0;
    const usedIn=[];
    function scanCap(n){
      if(n.meta?.type==='cap' && n.meta.cap===capId && n.id!==selectedId){
        usageCount++;
        // Find the process parent
        if(n.parent) usedIn.push(n.parent.label.replace(/\n/g,' '));
      }
      if(n.children) n.children.forEach(c=>scanCap(c));
    }
    scanCap(DATA);

    statRow.innerHTML=`<div class="stat-box"><div class="stat-val">${usageCount+1}</div><div class="stat-lbl">Verksamhetsbehov</div></div>`;
    capBox.style.display='block';
    document.getElementById('cap-info').innerHTML=`<b>${CAP_NAMES[capId]}</b><br>Anv√§nds av ${usageCount+1} verksamhetsbehov totalt.`+(usedIn.length>0?'<br><br>√Ñven i: '+usedIn.slice(0,6).join(', '):'');
    domBox.style.display='none';
  }
  // For process nodes (depth 2)
  else if(node.depth===2){
    desc.textContent=m.desc||'';
    infoPanel.style.display='block';
    statRow.innerHTML='';
    if(node.children){
      statRow.innerHTML=`<div class="stat-box"><div class="stat-val">${node.children.length}</div><div class="stat-lbl">F√∂rm√•gor</div></div>`;
    }
    capBox.style.display='block';
    const caps=node.children?node.children.filter(c=>c.meta?.type==='cap').map(c=>CAP_NAMES[c.meta.cap]||c.label.replace(/\n/g,' ')):[];
    document.getElementById('cap-info').innerHTML=caps.map(c=>'‚Ä¢ '+c).join('<br>');
    domBox.style.display='none';
  }
  // For domain nodes (depth 1)
  else if(node.depth===1){
    desc.textContent=m.desc||'';
    infoPanel.style.display='block';
    statRow.innerHTML='';
    if(node.children){
      statRow.innerHTML=`<div class="stat-box"><div class="stat-val">${node.children.length}</div><div class="stat-lbl">Behov</div></div>`;
      // Count total capabilities
      let capCount=0;
      node.children.forEach(p=>{if(p.children)capCount+=p.children.length});
      statRow.innerHTML+=`<div class="stat-box"><div class="stat-val">${capCount}</div><div class="stat-lbl">F√∂rm√•gor</div></div>`;
      // Unique caps
      const uniq=new Set();
      node.children.forEach(p=>{if(p.children)p.children.forEach(c=>{if(c.meta?.cap)uniq.add(c.meta.cap)})});
      statRow.innerHTML+=`<div class="stat-box"><div class="stat-val">${uniq.size}</div><div class="stat-lbl">Unika</div></div>`;
    }
    capBox.style.display='none';
    domBox.style.display='block';
    document.getElementById('dom-info').innerHTML=m.desc||'';
  }
  // Root
  else{
    desc.textContent=m.desc||'';
    infoPanel.style.display='block';
    statRow.innerHTML=`<div class="stat-box"><div class="stat-val">6</div><div class="stat-lbl">Dom√§ner</div></div><div class="stat-box"><div class="stat-val">27</div><div class="stat-lbl">Behov</div></div><div class="stat-box"><div class="stat-val">16</div><div class="stat-lbl">F√∂rm√•gor</div></div>`;
    capBox.style.display='none';domBox.style.display='none';
  }
}

// Domain filters
document.querySelectorAll('[data-dom]').forEach(el=>{
  el.addEventListener('click',function(){
    const d=this.dataset.dom;
    domVis[d]=!domVis[d];
    this.classList.toggle('active',domVis[d]);
    render();
  });
});

document.getElementById('shared-toggle').addEventListener('click',function(){showShared=!showShared;this.classList.toggle('active',showShared);render()});
document.getElementById('shared-labels-toggle').addEventListener('click',function(){showSharedLabels=!showSharedLabels;this.classList.toggle('active',showSharedLabels);render()});

// Zoom/pan
const wrap=document.getElementById('canvas-wrap');
let isPan=false, panS={x:0,y:0};
wrap.addEventListener('mousedown',e=>{if(e.button!==0)return;isPan=true;panS={x:e.clientX,y:e.clientY};wrap.classList.add('dragging')});
window.addEventListener('mousemove',e=>{if(!isPan)return;const dx=e.clientX-panS.x,dy=e.clientY-panS.y;panS={x:e.clientX,y:e.clientY};const r=svg.getBoundingClientRect();vb.x-=dx*(vb.w/r.width);vb.y-=dy*(vb.h/r.height);applyVB()});
window.addEventListener('mouseup',()=>{isPan=false;wrap.classList.remove('dragging')});
wrap.addEventListener('wheel',e=>{e.preventDefault();const f=e.deltaY>0?1.09:1/1.09;const r=svg.getBoundingClientRect();const mx=vb.x+((e.clientX-r.left)/r.width)*vb.w;const my=vb.y+((e.clientY-r.top)/r.height)*vb.h;vb.x=mx-(mx-vb.x)*f;vb.y=my-(my-vb.y)*f;vb.w*=f;vb.h*=f;applyVB()},{passive:false});
wrap.addEventListener('dblclick',e=>{e.preventDefault();fitVB();applyVB()});

document.getElementById('btn-reset-exp').addEventListener('click',resetExp);
document.getElementById('btn-reset-view').addEventListener('click',()=>{fitVB();applyVB()});
document.getElementById('btn-expand-all').addEventListener('click',expandAll);

// INIT
expandedIds.add('root');
renderFit();updatePanel();
</script>
</body>
</html>
